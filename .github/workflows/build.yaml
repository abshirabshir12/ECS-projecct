name: build docker image 

on: 
    workflow_dispatch:
permissions:
  id-token: write
  contents: read

env:
  ECR_REPOSITORY: ecs-projecct-repo
  IMAGE_TAG: latest 
  ECS_CLUSTER: ECS-projecct-ecs-cluster
  ECS_SERVICE: app 

jobs:
  build-and-deploy: 
    runs-on: ubuntu-latest
    

    steps: 
    - name: Checkout Code 
      uses: actions/checkout@v4


    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v3
      with:
        role-to-assume: arn:aws:iam::555569221122:role/ECS-projecct-github-actions-role
        aws-region: eu-west-2
    
    - name: Verify AWS identity
      run: aws sts get-caller-identity

    - name: Set up Docker
      uses: docker/setup-buildx-action@v3

    - name: Build Docker Image
      run: |
        docker build -t $ECR_REPOSITORY:$IMAGE_TAG ./app

    - name: Scan Docker Image with Trivy
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG  }}
        format: table
        severity: CRITICAL
        exit-code: 1
        ignore-unfixed: true

    - name: Log into ECR
      uses: aws-actions/amazon-ecr-login@v2

    - name: Tag and Push Docker Image
      run: |
        docker tag $ECR_REPOSITORY:$IMAGE_TAG 555569221122.dkr.ecr.${AWS_REGION}.amazonaws.com/$ECR_REPOSITORY:$IMAGE_TAG
        docker push 555569221122.dkr.ecr.${AWS_REGION}.amazonaws.com/$ECR_REPOSITORY:$IMAGE_TAG

    - name: Deploy to ECS
      run: |
        aws ecs update-service \
          --cluster $ECS_CLUSTER \
          --service $ECS_SERVICE \
          --force-new-deployment \
          --region $AWS_REGION